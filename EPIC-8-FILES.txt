# Epic 8: Admin Backend with RBAC and Audit Logging - File Structure

## Models (1 file)
/src/backend/models/audit_log.py                          116 lines

## Schemas (2 files)
/src/backend/schemas/admin_schemas.py                     287 lines
/src/backend/schemas/audit_schemas.py                      76 lines

## Services (2 files)  
/src/backend/services/admin_service.py                    582 lines
/src/backend/services/audit_service.py                    339 lines

## API Layer (3 files)
/src/backend/api/routes/admin.py                          642 lines
/src/backend/api/dependencies/admin.py                     39 lines
/src/backend/api/middleware/audit_middleware.py           142 lines

## Database Migrations (2 files)
/src/backend/alembic/versions/002_add_user_auth_fields.py  60 lines
/src/backend/alembic/versions/003_add_audit_logs.py        75 lines

## Tests (2 files)
/tests/backend/test_admin_api.py                          436 lines
/tests/backend/test_audit_logging.py                      488 lines

## Documentation (1 file)
/docs/contracts/story-8.5-8.6-contract.md                 804 lines

## Modified Files
/src/backend/models/user.py                               (Added 3 fields: is_admin, is_active, hashed_password)
/src/backend/models/__init__.py                           (Added AuditLog import)
/src/backend/api/main.py                                  (Added admin router and audit middleware)
/src/backend/api/routes/__init__.py                       (Added admin and feedback imports)

---

## Total Statistics

New Code Files: 8 files
New Migrations: 2 files
New Tests: 2 files
New Documentation: 1 file
Modified Files: 4 files

Total New Lines: ~2,243 lines of production code
Total Test Lines: ~924 lines of test code
Total Doc Lines: ~804 lines of documentation

Admin Endpoints: 12 endpoints
Audit Log Actions: 7+ action types
Database Indexes: 9 new indexes (2 on users, 7 on audit_logs)

---

## Admin API Endpoints

### User Management (4 endpoints)
GET    /api/v1/admin/users
GET    /api/v1/admin/users/{user_id}
PUT    /api/v1/admin/users/{user_id}/role
DELETE /api/v1/admin/users/{user_id}

### Plan Management (4 endpoints)
GET    /api/v1/admin/plans
POST   /api/v1/admin/plans
PUT    /api/v1/admin/plans/{plan_id}
DELETE /api/v1/admin/plans/{plan_id}

### Recommendation Management (1 endpoint)
GET    /api/v1/admin/recommendations

### System Statistics (1 endpoint)
GET    /api/v1/admin/stats

### Audit Logs (2 endpoints)
GET    /api/v1/admin/audit-logs
GET    /api/v1/admin/audit-logs/stats

---

## Security Features

- Role-Based Access Control (RBAC)
- Append-only audit logs
- Automatic data sanitization
- IP address tracking
- User agent logging
- Self-protection rules (can't modify own account)
- JWT authentication required
- 403 Forbidden for non-admins

---

## Database Schema Updates

### users table (updated)
+ hashed_password VARCHAR(255) NOT NULL
+ is_active BOOLEAN NOT NULL DEFAULT true
+ is_admin BOOLEAN NOT NULL DEFAULT false
+ idx_users_is_active
+ idx_users_is_admin

### audit_logs table (new)
+ id UUID PRIMARY KEY
+ timestamp TIMESTAMP WITH TIME ZONE NOT NULL
+ admin_user_id UUID REFERENCES users(id)
+ action VARCHAR(100) NOT NULL
+ resource_type VARCHAR(50) NOT NULL
+ resource_id UUID
+ details JSONB
+ ip_address VARCHAR(45)
+ user_agent TEXT
+ 7 indexes for efficient querying

---

## Success Criteria: All Met ✅

✅ All admin endpoints require admin role (RBAC enforced)
✅ Non-admin users receive 403 Forbidden
✅ Admin can manage users (list, view, update role, soft delete)
✅ Admin can manage plan catalog (CRUD operations)
✅ System stats endpoint returns accurate metrics
✅ All admin actions logged to audit_logs table
✅ Audit logs are append-only (no updates/deletes)
✅ Audit logs include IP address and user agent
✅ Audit log filtering and pagination work correctly
✅ All tests pass

