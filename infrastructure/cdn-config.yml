# CDN Configuration
# Story 7.3 - Epic 7: Performance Optimization
#
# CloudFront/Cloud CDN configuration for static asset delivery
# Target: <1s page load time with global distribution
#
# This configuration can be used with:
# - AWS CloudFront (recommended for AWS deployments)
# - Google Cloud CDN (recommended for GCP deployments)
# - Cloudflare CDN (alternative/additional layer)

---
cdn_provider: cloudfront  # Options: cloudfront, cloudcdn, cloudflare

# ============================================================================
# AWS CLOUDFRONT CONFIGURATION
# ============================================================================
cloudfront:
  distribution:
    enabled: true
    comment: "TreeBeard Energy Plan Recommendation - Static Assets CDN"

    # Origin Configuration
    origins:
      # S3 Origin for static assets
      - id: s3-static-assets
        domain_name: treebeard-static-assets.s3.us-east-1.amazonaws.com
        origin_path: ""
        origin_access_control:
          enabled: true
          signing_behavior: always
          signing_protocol: sigv4

      # Application origin for API/dynamic content
      - id: app-origin
        domain_name: api.treebeard.com
        custom_origin_config:
          http_port: 80
          https_port: 443
          origin_protocol_policy: https-only
          origin_ssl_protocols:
            - TLSv1.2
            - TLSv1.3
          origin_read_timeout: 30
          origin_keepalive_timeout: 5

    # Default Cache Behavior (for static assets)
    default_cache_behavior:
      target_origin_id: s3-static-assets
      viewer_protocol_policy: redirect-to-https
      allowed_methods:
        - GET
        - HEAD
        - OPTIONS
      cached_methods:
        - GET
        - HEAD
        - OPTIONS

      # Cache Policy
      cache_policy:
        min_ttl: 0
        default_ttl: 86400      # 1 day
        max_ttl: 31536000        # 1 year

      # Compression
      compress: true

      # Query String and Cookie Forwarding
      forwarded_values:
        query_string: false
        cookies:
          forward: none
        headers:
          - Origin
          - Access-Control-Request-Method
          - Access-Control-Request-Headers

      # Response Headers Policy
      response_headers_policy:
        cors:
          access_control_allow_origins:
            - https://treebeard.com
            - https://www.treebeard.com
          access_control_allow_methods:
            - GET
            - HEAD
            - OPTIONS
          access_control_allow_headers:
            - "*"
          access_control_max_age: 600

        security_headers:
          strict_transport_security:
            enabled: true
            max_age: 31536000
            include_subdomains: true
            preload: true

          content_security_policy:
            enabled: true
            policy: "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; font-src 'self' data:; connect-src 'self' https://api.treebeard.com"

          x_content_type_options:
            enabled: true
            value: nosniff

          x_frame_options:
            enabled: true
            value: DENY

          x_xss_protection:
            enabled: true
            value: "1; mode=block"

          referrer_policy:
            enabled: true
            value: strict-origin-when-cross-origin

    # Additional Cache Behaviors
    cache_behaviors:
      # Versioned static assets (JS, CSS with hashes)
      - path_pattern: /assets/*
        target_origin_id: s3-static-assets
        viewer_protocol_policy: redirect-to-https
        allowed_methods:
          - GET
          - HEAD
        cached_methods:
          - GET
          - HEAD
        compress: true
        cache_policy:
          min_ttl: 31536000      # 1 year
          default_ttl: 31536000  # 1 year
          max_ttl: 31536000      # 1 year
        forwarded_values:
          query_string: false
          cookies:
            forward: none

      # Images
      - path_pattern: /images/*
        target_origin_id: s3-static-assets
        viewer_protocol_policy: redirect-to-https
        allowed_methods:
          - GET
          - HEAD
        cached_methods:
          - GET
          - HEAD
        compress: true
        cache_policy:
          min_ttl: 86400         # 1 day
          default_ttl: 604800    # 1 week
          max_ttl: 31536000      # 1 year

      # HTML files (short cache)
      - path_pattern: "*.html"
        target_origin_id: s3-static-assets
        viewer_protocol_policy: redirect-to-https
        allowed_methods:
          - GET
          - HEAD
        cached_methods:
          - GET
          - HEAD
        compress: true
        cache_policy:
          min_ttl: 0
          default_ttl: 300       # 5 minutes
          max_ttl: 3600          # 1 hour

      # API requests (no CDN caching)
      - path_pattern: /api/*
        target_origin_id: app-origin
        viewer_protocol_policy: https-only
        allowed_methods:
          - GET
          - HEAD
          - OPTIONS
          - PUT
          - POST
          - PATCH
          - DELETE
        cached_methods:
          - GET
          - HEAD
        compress: true
        cache_policy:
          min_ttl: 0
          default_ttl: 0
          max_ttl: 0
        forwarded_values:
          query_string: true
          cookies:
            forward: all
          headers:
            - "*"

    # Geographic Restrictions
    geo_restriction:
      restriction_type: none  # Options: none, whitelist, blacklist
      # locations: []  # ISO 3166-1 alpha-2 country codes

    # Price Class (controls edge location distribution)
    price_class: PriceClass_100  # All edge locations (best performance)
    # Options:
    #   PriceClass_100: US, Canada, Europe
    #   PriceClass_200: + Asia, Middle East, Africa
    #   PriceClass_All: All edge locations

    # SSL/TLS Configuration
    viewer_certificate:
      acm_certificate_arn: arn:aws:acm:us-east-1:ACCOUNT_ID:certificate/CERT_ID
      ssl_support_method: sni-only
      minimum_protocol_version: TLSv1.2_2021
      cloudfront_default_certificate: false

    # Custom Domain
    aliases:
      - treebeard.com
      - www.treebeard.com

    # Default Root Object
    default_root_object: index.html

    # Custom Error Responses (for SPA routing)
    custom_error_responses:
      - error_code: 403
        response_code: 200
        response_page_path: /index.html
        error_caching_min_ttl: 0
      - error_code: 404
        response_code: 200
        response_page_path: /index.html
        error_caching_min_ttl: 0

    # Logging
    logging:
      enabled: true
      include_cookies: false
      bucket: treebeard-cdn-logs.s3.amazonaws.com
      prefix: cloudfront/

    # Web Application Firewall
    web_acl_id: arn:aws:wafv2:us-east-1:ACCOUNT_ID:global/webacl/treebeard/WAF_ID

# ============================================================================
# GOOGLE CLOUD CDN CONFIGURATION (Alternative)
# ============================================================================
cloud_cdn:
  enabled: true
  backend_bucket:
    name: treebeard-static-assets
    bucket_name: treebeard-static-assets
    enable_cdn: true

    cdn_policy:
      cache_mode: CACHE_ALL_STATIC
      default_ttl: 86400         # 1 day
      max_ttl: 31536000          # 1 year
      client_ttl: 86400          # 1 day
      negative_caching: true
      negative_caching_policy:
        - code: 404
          ttl: 300
        - code: 403
          ttl: 300

      # Cache Key Policy
      cache_key_policy:
        include_host: true
        include_protocol: true
        include_query_string: false
        query_string_whitelist: []

    compression_mode: AUTOMATIC

# ============================================================================
# CLOUDFLARE CONFIGURATION (Alternative/Additional Layer)
# ============================================================================
cloudflare:
  enabled: false
  zone_id: YOUR_ZONE_ID

  # Page Rules
  page_rules:
    - url: "treebeard.com/assets/*"
      actions:
        cache_level: cache_everything
        edge_cache_ttl: 31536000  # 1 year
        browser_cache_ttl: 31536000

    - url: "treebeard.com/*.html"
      actions:
        cache_level: cache_everything
        edge_cache_ttl: 300       # 5 minutes
        browser_cache_ttl: 300

    - url: "treebeard.com/api/*"
      actions:
        cache_level: bypass

  # Security Settings
  security:
    ssl: full_strict
    always_use_https: true
    min_tls_version: "1.2"
    automatic_https_rewrites: true
    opportunistic_encryption: true

    # DDoS Protection
    ddos_protection: true

    # Web Application Firewall
    waf:
      enabled: true
      mode: simulate  # Options: off, simulate, on

# ============================================================================
# CACHE BUSTING CONFIGURATION
# ============================================================================
cache_busting:
  # Asset fingerprinting/hashing (handled by Vite)
  enabled: true
  strategy: content_hash

  # Cache control headers
  headers:
    static_assets:
      Cache-Control: "public, max-age=31536000, immutable"

    images:
      Cache-Control: "public, max-age=604800"

    html:
      Cache-Control: "public, max-age=300, must-revalidate"

    api:
      Cache-Control: "no-cache, no-store, must-revalidate"
      Pragma: "no-cache"
      Expires: "0"

# ============================================================================
# MONITORING & ANALYTICS
# ============================================================================
monitoring:
  cloudwatch_alarms:
    - metric_name: 4xxErrorRate
      threshold: 5.0
      evaluation_periods: 2
      period: 300

    - metric_name: 5xxErrorRate
      threshold: 1.0
      evaluation_periods: 2
      period: 300

    - metric_name: CacheHitRate
      threshold: 80.0
      comparison_operator: LessThanThreshold
      evaluation_periods: 2
      period: 300

  # Real User Monitoring
  rum:
    enabled: true
    sample_rate: 0.1  # 10% of requests

# ============================================================================
# DEPLOYMENT NOTES
# ============================================================================
#
# AWS CLI Deployment:
#   aws cloudformation deploy \
#     --template-file cloudfront-stack.yml \
#     --stack-name treebeard-cdn \
#     --parameter-overrides $(cat cdn-config.yml)
#
# Terraform:
#   terraform apply -var-file="cdn-config.tfvars"
#
# CDN Invalidation (after deployment):
#   aws cloudfront create-invalidation \
#     --distribution-id E1234567890ABC \
#     --paths "/*"
#
# Performance Validation:
#   - Test from multiple geographic locations
#   - Verify cache hit ratios (target >90%)
#   - Measure page load times (target <1s)
#   - Check security headers with securityheaders.com
